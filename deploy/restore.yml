---
- name: Restore event data from CSV backup
  hosts: pi
  gather_facts: false

  vars:
    backup_path: ""

  tasks:
    - name: Validate backup_path is set
      ansible.builtin.assert:
        that: backup_path | length > 0
        fail_msg: "backup_path is required. Usage: task restore BACKUP=/path/to/backup/data/json"

    - name: Copy FrostByte events CSV to Pi
      ansible.builtin.copy:
        src: "{{ backup_path }}/frostbyte_events.csv"
        dest: /tmp/frostbyte_events.csv
        mode: "0644"
      register: frostbyte_csv
      ignore_errors: true

    - name: Copy LabelMaker events CSV to Pi
      ansible.builtin.copy:
        src: "{{ backup_path }}/labelmaker_events.csv"
        dest: /tmp/labelmaker_events.csv
        mode: "0644"
      register: labelmaker_csv
      ignore_errors: true

    - name: Fail if no CSV files found
      ansible.builtin.assert:
        that: frostbyte_csv is succeeded or labelmaker_csv is succeeded
        fail_msg: "No event CSV files found in {{ backup_path }}"

    - name: Restore FrostByte events
      ansible.builtin.command:
        cmd: "{{ repo_path }}/common/backup/event-restore.sh frostbyte /tmp/frostbyte_events.csv"
      when: frostbyte_csv is succeeded
      changed_when: true

    - name: Restore LabelMaker events
      ansible.builtin.command:
        cmd: "{{ repo_path }}/common/backup/event-restore.sh labelmaker /tmp/labelmaker_events.csv"
      when: labelmaker_csv is succeeded
      changed_when: true

    - name: Clean up temp files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/frostbyte_events.csv
        - /tmp/labelmaker_events.csv
