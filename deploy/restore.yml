---
- name: Restore event data from CSV backup
  hosts: pi
  gather_facts: false

  vars:
    frostbyte_csv: ""
    labelmaker_csv: ""

  tasks:
    - name: Validate at least one CSV is provided
      ansible.builtin.assert:
        that: (frostbyte_csv | length > 0) or (labelmaker_csv | length > 0)
        fail_msg: "At least one CSV is required. Usage: task restore FROSTBYTE_CSV=/path/to/file [LABELMAKER_CSV=/path/to/file]"

    - name: Copy FrostByte events CSV to Pi
      ansible.builtin.copy:
        src: "{{ frostbyte_csv }}"
        dest: /tmp/frostbyte_events.csv
        mode: "0644"
      when: frostbyte_csv | length > 0

    - name: Copy LabelMaker events CSV to Pi
      ansible.builtin.copy:
        src: "{{ labelmaker_csv }}"
        dest: /tmp/labelmaker_events.csv
        mode: "0644"
      when: labelmaker_csv | length > 0

    - name: Restore FrostByte events
      ansible.builtin.command:
        cmd: "{{ repo_path }}/common/backup/event-restore.sh frostbyte /tmp/frostbyte_events.csv"
      when: frostbyte_csv | length > 0
      changed_when: true

    - name: Restore LabelMaker events
      ansible.builtin.command:
        cmd: "{{ repo_path }}/common/backup/event-restore.sh labelmaker /tmp/labelmaker_events.csv"
      when: labelmaker_csv | length > 0
      changed_when: true

    - name: Clean up temp files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/frostbyte_events.csv
        - /tmp/labelmaker_events.csv
